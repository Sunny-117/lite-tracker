# Elasticsearch 介绍

elasticsearch 是一款非常强大的开源搜索引擎，具备非常多强大功能，可以帮助我们从海量数据中快速找到需要的内容。

官方地址: https://www.elastic.co/guide/cn/elasticsearch/guide/2.x/intro.html

## 倒排索引原理

### 1.正向索引

什么是正向索引呢？例如给下表（tb_goods）中的 id 创建索引：

<img src="https://zwhid.oss-cn-shenzhen.aliyuncs.com/blog/05-30-fKwSGd.png"  />

如果是根据 id 查询，那么直接走索引，查询速度非常快。

但如果是基于 title 做模糊查询，只能是逐行扫描数据，流程如下：

1）用户搜索数据，条件是 title 符合`"%手机%"`

2）逐行获取数据，比如 id 为 1 的数据

3）判断数据中的 title 是否符合用户搜索条件

4）如果符合则放入结果集，不符合则丢弃。回到步骤 1

逐行扫描，也就是全表扫描，随着数据量增加，其查询效率也会越来越低。当数据量达到数百万时，就是一场灾难。

### 2.倒排索引

倒排索引中有两个非常重要的概念：

- 文档（`Document`）：用来搜索的数据，其中的每一条数据就是一个文档。例如一个网页、一个商品信息
- 词条（`Term`）：对文档数据或用户搜索数据，利用某种算法分词，得到的具备含义的词语就是词条。例如：我是中国人，就可以分为：我、是、中国人、中国、国人这样的几个词条

**创建倒排索引**是对正向索引的一种特殊处理，流程如下：

- 将每一个文档的数据利用算法分词，得到一个个词条
- 创建表，每行数据包括词条、词条所在文档 id、位置等信息
- 因为词条唯一性，可以给词条创建索引，例如 hash 表结构索引

如图：

![](https://zwhid.oss-cn-shenzhen.aliyuncs.com/blog/05-30-sBG2Lf.png)

倒排索引的**搜索流程**如下（以搜索"华为手机"为例）：

1）用户输入条件`"华为手机"`进行搜索。

2）对用户输入内容**分词**，得到词条：`华为`、`手机`。

3）拿着词条在倒排索引中查找，可以得到包含词条的文档 id：1、2、3。

4）拿着文档 id 到正向索引中查找具体文档。

如图：

<img src="https://zwhid.oss-cn-shenzhen.aliyuncs.com/blog/05-30-XRTD1F.png" style="zoom: 67%;" />

虽然要先查询倒排索引，再查询倒排索引，但是无论是词条、还是文档 id 都建立了索引，查询速度非常快！无需全表扫描。

### 3.正向和倒排

那么为什么一个叫做正向索引，一个叫做倒排索引呢？

- **正向索引**是最传统的，根据 id 索引的方式。但根据词条查询时，必须先逐条获取每个文档，然后判断文档中是否包含所需要的词条，是**根据文档找词条的过程**。

- 而**倒排索引**则相反，是先找到用户要搜索的词条，根据词条得到保护词条的文档的 id，然后根据 id 获取文档。是**根据词条找文档的过程**。

## ES 的概念

### 1. mysql 和 elasticsearch 的概念对比理解

| **MySQL**     | **Elasticsearch** | **说明**                                                                           |
| ------------- | ----------------- | ---------------------------------------------------------------------------------- |
| Table         | Index             | 索引(index)，就是文档的集合，类似数据库的表(table)                                 |
| Row           | Document          | 文档（Document），就是一条条的数据，类似数据库中的行（Row），文档都是 JSON 格式    |
| Column        | Field             | 字段（Field），就是 JSON 文档中的字段，类似数据库中的列（Column）                  |
| Schema（DDL） | Mapping           | Mapping（映射）是索引中文档的约束，例如字段类型约束。类似数据库的表结构（Schema）  |
| SQL           | DSL               | DSL 是 elasticsearch 提供的 JSON 风格的请求语句，用来操作 elasticsearch，实现 CRUD |

### 2.文档和字段

elasticsearch 是面向**文档（Document）就是说 ES 存储的都是 JSON 数据**存储的，可以是数据库中的一条商品数据，一个订单信息。文档数据会被序列化为 json 格式后存储在 elasticsearch 中：

<img src="https://zwhid.oss-cn-shenzhen.aliyuncs.com/blog/05-30-NdN8ia.png" style="zoom:67%;" />

而 Json 文档中往往包含很多的**字段（Field）**，类似于数据库中的列。

### 3.索引和映射

**索引（Index）**，就是相同类型的文档的集合。

例如：

- 所有用户文档，就可以组织在一起，称为用户的索引；
- 所有商品的文档，可以组织在一起，称为商品的索引；
- 所有订单的文档，可以组织在一起，称为订单的索引；

<img src="https://zwhid.oss-cn-shenzhen.aliyuncs.com/blog/05-30-eMN0VP.png" style="zoom:67%;" />

因此，我们可以把索引当做是数据库中的表。

数据库的表会有约束信息，用来定义表的结构、字段的名称、类型等信息。因此，索引库中就有**映射（mapping）**这样的概念，是索引中文档的字段约束信息，类似表的结构约束。

### 4.elasticsearch 的应用场景

- Elasticsearch：擅长海量数据的搜索、分析、计算

- Mysql：擅长事务类型操作，可以确保数据的安全和一致性

在企业中，往往 mysql 和 elasticsearch 是两者结合使用：

- 对安全性要求较高的写操作，使用 mysql 实现
- 对查询性能要求较高的搜索需求，使用 elasticsearch 实现
- 两者再基于某种方式，实现数据的同步，保证一致性

![](https://zwhid.oss-cn-shenzhen.aliyuncs.com/blog/05-30-ZmlQM1.png)

## 索引库操作

索引库就类似数据库表，mapping 映射就类似表的结构。我们要向 es 中存储数据，必须先创建“库”和“表”。就需要编写 DDL 语句实现创建库和表。之前我们对比理解过 mapping 等同于数据库中 DDL。

### 1.mapping 映射属性

mapping 是对索引库中文档的约束，具体的映射针对的是字段。常见的 mapping 属性包括：

| 属性名     | 描述                                                                                                                                           |
| ---------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| type       | 字符串：text（可分词的文本）、keyword（精确值，例如：品牌、国家、ip 地址） long、integer、short、byte、double、float、 boolean 、date 、object |
| index      | 是否创建索引，默认为 true                                                                                                                      |
| analyzer   | 使用哪种分词器（前提是：要分词 才需要指定分词器）                                                                                              |
| properties | 该字段的子字段                                                                                                                                 |

举例拿常见的属性理解如下：

```html
具体的映射 注意 举例子针对 Field（数据库中的列）来说 包括常见的属性 + 是否分词
分词的目的是为了要去建立倒排索引 + 分词器是什么 根据需要确定 + 数据类型什么
根据需求来确定 + 是否要索引 要索引的目的是为了快速的搜索
如下商品信息包括：商品ID,商品名称，价格，图片地址.
需要设置好数据类型，那么商品ID是long 需要设置是否分词，那么商品ID 不需要分词
需要设置是否要索引，那么商品ID 需要建立索引
需要设置如果要分词，采用什么样的分词器
```

![1645799
